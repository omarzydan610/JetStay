name: JetStay Pipeline

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["main", "master"]

jobs:
  backend-setup:
    name: Backend - Setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

  backend-build:
    name: Backend - Build
    runs-on: ubuntu-latest
    needs: backend-setup
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Build backend
        run: mvn clean compile -DskipTests
        working-directory: backend

  backend-test:
    name: Backend - Test
    runs-on: ubuntu-latest
    needs: backend-build
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Run tests and generate coverage
        run: mvn clean test jacoco:report
        working-directory: backend

      - name: Upload full HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: backend/target/site/jacoco/

      - name: Extract coverage percentage
        id: coverage
        run: |
          FILE="backend/target/site/jacoco/jacoco.xml"

          if [[ ! -f "$FILE" ]]; then
            echo "Coverage XML not found at $FILE"
            echo "Listing directory contents:"
            ls -la backend/target/site/jacoco/ || true
            exit 1
          fi

          # Extract coverage using Python to parse XML properly
          # Get the root-level LINE counter (last one in the file)
          LINE_RATE=$(python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import sys

          try:
              tree = ET.parse('backend/target/site/jacoco/jacoco.xml')
              root = tree.getroot()
              
              # Find all LINE counters and get the root-level one (last one)
              counters = root.findall('.//counter[@type="LINE"]')
              if counters:
                  # Get the last counter which should be the root/total
                  counter = counters[-1]
                  covered = int(counter.get('covered', 0))
                  missed = int(counter.get('missed', 0))
                  total = covered + missed
                  
                  if total > 0:
                      rate = (covered / total) * 100
                      print(f'{rate:.2f}')
                  else:
                      print('0.00')
              else:
                  print('0.00')
          except Exception as e:
              print(f'Error: {e}', file=sys.stderr)
              sys.exit(1)
          EOF
          )

          if [[ -z "$LINE_RATE" ]]; then
            echo "Could not extract coverage from XML file!"
            echo "First 100 characters of XML file:"
            head -c 100 "$FILE" || true
            exit 1
          fi

          echo "line_rate=$LINE_RATE" >> $GITHUB_OUTPUT
          echo "Extracted line coverage: $LINE_RATE%"

      - name: Add coverage to GitHub Summary
        run: |
          echo "### Backend Test Coverage: **${{ steps.coverage.outputs.line_rate }}%**" >> $GITHUB_STEP_SUMMARY

      - name: Comment Coverage on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## âœ… Backend Test Coverage Report
            | Metric | Value |
            |--------|-------|
            | Line Coverage | **${{ steps.coverage.outputs.line_rate }}%** |
            | Coverage Report | Available in CI Artifacts |

  frontend-setup:
    name: Frontend - Setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node

  frontend-build:
    name: Frontend - Build
    runs-on: ubuntu-latest
    needs: frontend-setup
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node

      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      - name: Build React app
        run: npm run build
        working-directory: frontend

  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR title format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Checking PR Title: $PR_TITLE"

          if [[ "$PR_TITLE" =~ ^\[JET-[0-9]+\] ]] || [[ "$PR_TITLE" =~ ^\[NOJET\] ]]; then
            echo "PR title format is valid!"
            exit 0
          fi

          echo "ERROR: Invalid PR title format."
          echo "Expected formats:"
          echo "  [JET-123] Your title"
          echo "  [NOJET] Your title"
          exit 1
