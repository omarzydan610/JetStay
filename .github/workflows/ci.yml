name: JetStay Pipeline

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["main", "master"]

# =========================================================
# ================= BACKEND ===============================
# =========================================================

jobs:
  backend-setup:
    name: Backend - Setup
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

  backend-build:
    name: Backend - Build
    runs-on: ubuntu-latest
    needs: backend-setup

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Build backend
        run: mvn clean compile -DskipTests
        working-directory: backend

  backend-test:
    name: Backend - Test & Coverage
    runs-on: ubuntu-latest
    needs: backend-build
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Run tests & generate JaCoCo report
        run: mvn clean test jacoco:report
        working-directory: backend

      - name: Upload JaCoCo HTML report
        uses: actions/upload-artifact@v4
        with:
          name: backend-jacoco-report
          path: backend/target/site/jacoco/

      # -----------------------------------------------------
      # Extract Coverage & Statistics (FIXED)
      # -----------------------------------------------------
      - name: Extract coverage statistics
        id: coverage
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          from pathlib import Path
          import os

          # ---------- Parse JaCoCo ----------
          tree = ET.parse("backend/target/site/jacoco/jacoco.xml")
          root = tree.getroot()

          counter = root.findall('.//counter[@type="LINE"]')[-1]
          covered = int(counter.get("covered"))
          missed = int(counter.get("missed"))
          total = covered + missed
          rate = (covered / total * 100) if total else 0

          indicator = "üü¢" if rate >= 80 else "üü°" if rate >= 60 else "üî¥"

          # ---------- Java Files ----------
          main_files = {
              f.stem for f in Path("backend/src/main/java").rglob("*.java")
          }
          test_files = {
              f.stem.replace("Test", "")
              for f in Path("backend/src/test/java").rglob("*Test.java")
          }

          tested = sorted(main_files & test_files)
          untested = sorted(main_files - test_files)

          # ---------- GitHub Outputs ----------
          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a") as f:
              f.write(f"line_rate={rate:.2f}\n")
              f.write(f"covered_lines={covered}\n")
              f.write(f"total_lines={total}\n")
              f.write(f"indicator={indicator}\n")
              f.write(f"total_files={len(main_files)}\n")
              f.write(f"tested_files={len(tested)}\n")
              f.write(f"untested_files={len(untested)}\n")

              # üî• MULTILINE SAFE OUTPUT
              f.write("untested_files_list<<EOF\n")
              for file in untested:
                  f.write(file + "\n")
              f.write("EOF\n")
          EOF

      # -----------------------------------------------------
      # GitHub Summary
      # -----------------------------------------------------
      - name: Add coverage to GitHub Summary
        run: |
          echo "## üìä Backend Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${{ steps.coverage.outputs.indicator }} Line Coverage:** **${{ steps.coverage.outputs.line_rate }}%**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Lines: ${{ steps.coverage.outputs.covered_lines }} / ${{ steps.coverage.outputs.total_lines }}" >> $GITHUB_STEP_SUMMARY
          echo "- Java Files: ${{ steps.coverage.outputs.total_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- With Tests: ${{ steps.coverage.outputs.tested_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- Without Tests: ${{ steps.coverage.outputs.untested_files }}" >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------
      # PR COMMENT (NOW LIST IS CLEAN ‚úÖ)
      # -----------------------------------------------------
      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## üìä Backend Coverage Report

            ### Overall Coverage
            **${{ steps.coverage.outputs.indicator }} Line Coverage: `${{ steps.coverage.outputs.line_rate }}%`**

            ```
            ${{ steps.coverage.outputs.covered_lines }} / ${{ steps.coverage.outputs.total_lines }} lines covered
            ```

            ---

            ### üìÅ Project Statistics

            | Metric | Value |
            |------|------|
            | Total Java Files | **${{ steps.coverage.outputs.total_files }}** |
            | Files With Tests | **${{ steps.coverage.outputs.tested_files }}** |
            | Files Without Tests | **${{ steps.coverage.outputs.untested_files }}** |

            ---

            ### üö® Files Missing Tests
            <details>
            <summary>Click to expand</summary>

            ```
            ${{ steps.coverage.outputs.untested_files_list }}
            ```

            </details>

            üì¶ Full HTML coverage report is available in CI Artifacts

  # =========================================================
  # ================= PAYMENT SERVICE ======================
  # =========================================================

  payment-test:
    name: Payment Service - Test & Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-cov
        working-directory: microservice/payment

      - name: Run tests with coverage
        run: |
          pytest --cov=app --cov-report=html --cov-report=term-summary tests/
        working-directory: microservice/payment

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: payment-coverage-report
          path: microservice/payment/htmlcov/

      - name: Extract coverage statistics
        id: coverage
        run: |
          python3 << 'EOF'
          import re
          import os

          # Parse coverage report
          with open("microservice/payment/.coverage", "rb") as f:
              content = f.read()

          # Run pytest with json output for more reliable parsing
          import subprocess
          result = subprocess.run(
              ["pytest", "--cov=app", "--cov-report=term-summary", "tests/"],
              cwd="microservice/payment",
              capture_output=True,
              text=True
          )

          # Extract coverage percentage from output
          match = re.search(r"TOTAL\s+(\d+)\s+(\d+)\s+([\d.]+)%", result.stdout)
          if match:
              statements = int(match.group(1))
              missing = int(match.group(2))
              coverage_rate = float(match.group(3))
              covered = statements - missing
          else:
              coverage_rate = 0
              covered = 0
              statements = 0

          indicator = "üü¢" if coverage_rate >= 80 else "üü°" if coverage_rate >= 60 else "üî¥"

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a") as f:
              f.write(f"coverage_rate={coverage_rate:.2f}\n")
              f.write(f"covered_lines={covered}\n")
              f.write(f"total_lines={statements}\n")
              f.write(f"indicator={indicator}\n")
          EOF

      - name: Add coverage to GitHub Summary
        run: |
          echo "## üìä Payment Service Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${{ steps.coverage.outputs.indicator }} Coverage:** **${{ steps.coverage.outputs.coverage_rate }}%**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Statements: ${{ steps.coverage.outputs.covered_lines }} / ${{ steps.coverage.outputs.total_lines }}" >> $GITHUB_STEP_SUMMARY

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## üìä Payment Service Coverage Report

            **${{ steps.coverage.outputs.indicator }} Coverage: `${{ steps.coverage.outputs.coverage_rate }}%`**

            ```
            ${{ steps.coverage.outputs.covered_lines }} / ${{ steps.coverage.outputs.total_lines }} statements covered
            ```

            üì¶ Full HTML coverage report is available in CI Artifacts

  # =========================================================
  # ================= FRONTEND ==============================
  # =========================================================

  frontend-build:
    name: Frontend - Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node

      - run: npm ci
        working-directory: frontend

      - run: npm run build
        working-directory: frontend

  # =========================================================
  # ================= PR TITLE ==============================
  # =========================================================

  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Validate PR title format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          if [[ "$PR_TITLE" =~ ^\[JET-[0-9]+\] ]] || [[ "$PR_TITLE" =~ ^\[NOJET\] ]]; then
            exit 0
          fi

          echo "‚ùå Invalid PR title format"
          exit 1
