name: JetStay Pipeline

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["main", "master"]

jobs:
  # =========================================================
  # ================= BACKEND ===============================
  # =========================================================

  backend-test:
    name: Backend - Test & Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Run tests and generate JaCoCo report
        run: mvn clean test jacoco:report
        working-directory: backend

      - name: Upload JaCoCo HTML report
        uses: actions/upload-artifact@v4
        with:
          name: backend-jacoco-report
          path: backend/target/site/jacoco/

      # -----------------------------------------------------
      # Extract Coverage & Project Statistics
      # -----------------------------------------------------
      - name: Extract coverage statistics
        id: coverage
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import os
          from pathlib import Path

          JACOCO_XML = "backend/target/site/jacoco/jacoco.xml"

          tree = ET.parse(JACOCO_XML)
          root = tree.getroot()

          # ---- LINE COVERAGE ----
          counters = root.findall('.//counter[@type="LINE"]')
          counter = counters[-1]
          covered = int(counter.get('covered'))
          missed = int(counter.get('missed'))
          total = covered + missed
          rate = (covered / total * 100) if total else 0

          # ---- COVERAGE INDICATOR ----
          if rate >= 80:
              indicator = "üü¢"
          elif rate >= 60:
              indicator = "üü°"
          else:
              indicator = "üî¥"

          # ---- JAVA FILES ----
          main_files = {
              f.stem
              for f in Path("backend/src/main/java").rglob("*.java")
          }

          test_files = {
              f.stem.replace("Test", "")
              for f in Path("backend/src/test/java").rglob("*Test.java")
          }

          tested = sorted(main_files & test_files)
          untested = sorted(main_files - test_files)

          # ---- OUTPUT ----
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"line_rate={rate:.2f}\n")
              out.write(f"covered_lines={covered}\n")
              out.write(f"total_lines={total}\n")
              out.write(f"indicator={indicator}\n")
              out.write(f"total_files={len(main_files)}\n")
              out.write(f"tested_files={len(tested)}\n")
              out.write(f"untested_files={len(untested)}\n")
              out.write("untested_files_list=" + "\\n".join(untested) + "\n")
          EOF

      # -----------------------------------------------------
      # GitHub Summary
      # -----------------------------------------------------
      - name: Add coverage to GitHub Summary
        run: |
          echo "## üìä Backend Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${{ steps.coverage.outputs.indicator }} Line Coverage:** **${{ steps.coverage.outputs.line_rate }}%**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Lines Covered: ${{ steps.coverage.outputs.covered_lines }} / ${{ steps.coverage.outputs.total_lines }}" >> $GITHUB_STEP_SUMMARY
          echo "- Java Files: ${{ steps.coverage.outputs.total_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- Files With Tests: ${{ steps.coverage.outputs.tested_files }}" >> $GITHUB_STEP_SUMMARY
          echo "- Files Without Tests: ${{ steps.coverage.outputs.untested_files }}" >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------
      # PR COMMENT (PRETTY & STRUCTURED)
      # -----------------------------------------------------
      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## üìä Backend Coverage Report

            ### Overall Coverage
            **${{ steps.coverage.outputs.indicator }} Line Coverage: `${{ steps.coverage.outputs.line_rate }}%`**

            ```
            ${{ steps.coverage.outputs.covered_lines }} / ${{ steps.coverage.outputs.total_lines }} lines covered
            ```

            ---

            ### üìÅ Project Statistics

            | Metric | Value |
            |------|------|
            | Total Java Files | **${{ steps.coverage.outputs.total_files }}** |
            | Files With Tests | **${{ steps.coverage.outputs.tested_files }}** |
            | Files Without Tests | **${{ steps.coverage.outputs.untested_files }}** |

            ---

            ### üö® Files Missing Tests
            <details>
            <summary>Click to expand</summary>

            ```
            ${{ steps.coverage.outputs.untested_files_list }}
            ```

            </details>

            ---

            üì¶ **Full HTML coverage report** is available in **GitHub Actions Artifacts**

            üí° **Suggestion:** Aim for **‚â• 80%** line coverage before merging.

  # =========================================================
  # ================= FRONTEND ==============================
  # =========================================================

  frontend-build:
    name: Frontend - Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node

      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      - name: Build React app
        run: npm run build
        working-directory: frontend

  # =========================================================
  # ================= PR TITLE VALIDATION ===================
  # =========================================================

  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Validate PR title format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Checking PR Title: $PR_TITLE"

          if [[ "$PR_TITLE" =~ ^\[JET-[0-9]+\] ]] || [[ "$PR_TITLE" =~ ^\[NOJET\] ]]; then
            echo "PR title format is valid!"
            exit 0
          fi

          echo "‚ùå Invalid PR title format"
          echo "Expected:"
          echo "  [JET-123] Title"
          echo "  [NOJET] Title"
          exit 1
