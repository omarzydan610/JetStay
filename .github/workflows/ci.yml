name: JetStay Pipeline

on:
  pull_request:
    branches: ["**"]
  push:
    branches: ["main", "master"]

# =========================================================
# ================= BACKEND ===============================
# =========================================================

jobs:
  backend-setup:
    name: Backend - Setup
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

  backend-build:
    name: Backend - Build
    runs-on: ubuntu-latest
    needs: backend-setup

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Build backend
        working-directory: backend
        run: mvn clean compile -DskipTests

  backend-test:
    name: Backend - Test & Coverage
    runs-on: ubuntu-latest
    needs: backend-build
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven

      - name: Run backend tests & JaCoCo
        working-directory: backend
        run: mvn clean test jacoco:report

      - name: Upload backend coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-jacoco-report
          path: backend/target/site/jacoco/

      # ---------- Backend coverage extraction ----------
      - name: Extract backend coverage
        id: backend
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          from pathlib import Path
          import os

          tree = ET.parse("backend/target/site/jacoco/jacoco.xml")
          root = tree.getroot()

          c = root.findall('.//counter[@type="LINE"]')[-1]
          covered = int(c.get("covered"))
          missed = int(c.get("missed"))
          total = covered + missed
          rate = (covered / total * 100) if total else 0

          indicator = "üü¢" if rate >= 80 else "üü°" if rate >= 60 else "üî¥"

          main = {f.stem for f in Path("backend/src/main/java").rglob("*.java")}
          tests = {f.stem.replace("Test", "") for f in Path("backend/src/test/java").rglob("*Test.java")}
          untested = sorted(main - tests)

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a") as f:
              f.write(f"indicator={indicator}\n")
              f.write(f"rate={rate:.2f}\n")
              f.write(f"covered={covered}\n")
              f.write(f"total={total}\n")
              f.write(f"untested_count={len(untested)}\n")
              f.write("untested<<EOF\n")
              for x in untested:
                  f.write(x + "\n")
              f.write("EOF\n")
          EOF

      # ---------- Download payment coverage ----------
      - name: Download payment coverage metadata
        uses: actions/download-artifact@v4
        with:
          name: payment-coverage-meta
          path: payment

      - name: Read payment coverage
        id: payment
        run: |
          {
            echo "indicator=$(sed -n '1p' payment/payment.txt)"
            echo "rate=$(sed -n '2p' payment/payment.txt)"
            echo "covered=$(sed -n '3p' payment/payment.txt)"
            echo "total=$(sed -n '4p' payment/payment.txt)"
          } >> $GITHUB_OUTPUT

      # ---------- Unified PR comment ----------
      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## üìä JetStay Coverage Report

            ---

            ### üß† Backend Service
            **${{ steps.backend.outputs.indicator }} Line Coverage: `${{ steps.backend.outputs.rate }}%`**

            ```
            ${{ steps.backend.outputs.covered }} / ${{ steps.backend.outputs.total }} lines covered
            ```

            **Files without tests:** `${{ steps.backend.outputs.untested_count }}`

            <details>
            <summary>üö® Untested Backend Files</summary>

            ```
            ${{ steps.backend.outputs.untested }}
            ```

            </details>

            ---

            ### üí≥ Payment Service
            **${{ steps.payment.outputs.indicator }} Coverage: `${{ steps.payment.outputs.rate }}%`**

            ```
            ${{ steps.payment.outputs.covered }} / ${{ steps.payment.outputs.total }} statements covered
            ```

            ---

            üì¶ Full HTML reports are available in CI Artifacts

  # =========================================================
  # ================= PAYMENT SERVICE ======================
  # =========================================================

  payment-setup:
    name: Payment Service - Setup
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('microservice/payment/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip

      - name: Install dependencies
        working-directory: microservice/payment
        run: |
          pip install -r requirements.txt
          pip install pytest-cov

  payment-test:
    name: Payment Service - Test & Coverage
    runs-on: ubuntu-latest
    needs: payment-setup

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        working-directory: microservice/payment
        run: |
          pip install -r requirements.txt
          pip install pytest-cov

      - name: Run payment tests
        working-directory: microservice/payment
        run: |
          PYTHONPATH=$(pwd):$PYTHONPATH \
          pytest --cov=app --cov-report=html --cov-report=json --cov-report=term-missing tests/

      - name: Upload payment HTML coverage
        uses: actions/upload-artifact@v4
        with:
          name: payment-coverage-report
          path: microservice/payment/htmlcov/

      - name: Extract payment coverage
        run: |
          python3 << 'EOF'
          import json, os

          with open("microservice/payment/coverage.json") as f:
              data = json.load(f)

          total_statements = data["totals"]["num_statements"]
          total_missing = data["totals"]["missing_lines"]
          coverage_rate = data["totals"]["percent_covered"]
          covered = total_statements - total_missing

          indicator = "üü¢" if coverage_rate >= 80 else "üü°" if coverage_rate >= 60 else "üî¥"

          os.makedirs("coverage_meta", exist_ok=True)
          with open("coverage_meta/payment.txt", "w") as f:
              f.write(f"{indicator}\n{coverage_rate:.2f}\n{covered}\n{total_statements}\n")
          EOF

      - name: Upload payment coverage metadata
        uses: actions/upload-artifact@v4
        with:
          name: payment-coverage-meta
          path: coverage_meta/payment.txt

  # =========================================================
  # ================= FRONTEND ==============================
  # =========================================================

  frontend-build:
    name: Frontend - Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node

      - run: npm ci
        working-directory: frontend

      - run: npm run build
        working-directory: frontend

  # =========================================================
  # ================= PR TITLE ==============================
  # =========================================================

  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Validate PR title format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          if [[ "$PR_TITLE" =~ ^\[JET-[0-9]+\] ]] || [[ "$PR_TITLE" =~ ^\[NOJET\] ]]; then
            exit 0
          fi

          echo "‚ùå Invalid PR title format"
          exit 1
